<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>后台首页</title>
	<link rel="stylesheet" type="text/css" href="/oxd-web/static/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="/oxd-web/static/easyui/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="/oxd-web/static/umeditor/themes/default/css/umeditor.css">
	<script type="text/javascript" src="/oxd-web/static/easyui/jquery.min.js"></script>
	<script type="text/javascript" src="/oxd-web/static/easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="/oxd-web/static/umeditor/umeditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="/oxd-web/static/umeditor/umeditor.min.js"></script>
    <script type="text/javascript" src="/oxd-web/static/umeditor/lang/zh-cn/zh-cn.js"></script>
    <style>
    body,html {
    	height: 100%;
    }
    .dgheight {
    	height: 100%;
    }
    </style>
</head>
<body style="padding:0;margin:0; overflow: hidden;">
	<table id="dg" title="资讯管理" class="easyui-datagrid" style="width:100%; height:100%;" data-options="singleSelect:true,autoRowHeight:false,cls:'dgheight'">
	</table>
	<script type="text/javascript" src="/oxd-web/static/js/fastjson-1.0.min.js"></script>
	<script type="text/javascript" src="/oxd-web/static/js/ajaxfileupload.js"></script>
	<script type="text/javascript">
	$.extend($.fn.validatebox.defaults.rules, { 
		jianjieValid : { 
			validator : function(value, param) { 
				if(value && value.length > 0 && value.length <= 200) 
					return true; 
				return false;
			}, 
			message : '内容简介字数应在1-200之间。' 
		},
		titleValid : { 
			validator : function(value, param) { 
				if(value && value.length > 0 && value.length <= 100) 
					return true; 
				return false;
			}, 
			message : '标题字数应在1-100之间。' 
		}
	});
	
	$(function(){
		$('#dg').datagrid({
			url:'search',  
		    columns:[[  
				{field:'ck',checkbox: true},  
		        {field:'id',title:'ID'},  
		        {field:'title',title:'标题'},  
		        {field:'prePictureUrl',title:'前置图地址'},
		        {field:'type',title:'类型'},
		        {field:'introduction',title:'内容简介',formatter:function(value,row,index){
		        	var val = value;
		        	if(val && val.length > 20) {
		        		val = '<span title="' + val + '">' + val.substring(0, 20) + '...</span>';
		        	}
		        	return val;
		        }},
		        {field:'createTime',title:'创建时间'},
		        {field:'createUser',title:'创建人', width:60},
		        {field:'updateTime',title:'修改时间'},
		        {field:'updateUser',title:'修改人', width:60}
		    ]],
		    pagination:true,
		    rownumbers:true,
		    toolbar: [{ 
	            text: '添加', 
	            iconCls: 'icon-add', 
	            handler: function() { 
	            	$('#addDialog').dialog('open');
	            	$.parser.parse($('#pwdUpdateForm').parent());
	            	$("#pwdUpdateForm input").val("");
	            	UM.getEditor('myEditor').setContent('', false);
	            } 
	        }, '-', { 
	            text: '修改', 
	            iconCls: 'icon-edit', 
	            handler: function() { 
	            	editDialog(); 
	            } 
	        }, '-',{ 
	            text: '删除', 
	            iconCls: 'icon-remove', 
	            handler: function(){ 
	            	 alert("删除");
	            } 
	        }]
		});
		$('<td style="padding: 0 8px;"><input id="ss" class="easyui-searchbox" data-options="searcher:doSearch" style="width:160px" /></td>').prependTo(".datagrid-toolbar table tbody tr");
		
		$.parser.parse($('#ss').parent());
		
		//实例化编辑器
	    var um = UM.getEditor('myEditor');
	});
	
	// 搜索
	function doSearch(value) {
		alert(value);
	}
	
	//上传文件
	function ajaxFileUpload(){
	    if($("input[name='upfile']").val() == "") {
	    	return;
	    }
	    $.ajaxFileUpload
	    (
	        {
	            url:'/oxd-web/upload/editorImage',
	            secureuri:false,
	            fileElementId:$("input[name='upfile']").attr("id"),
	            dataType: 'json',
	            success: function (data, status)
	            {
	                if(data.state == 'SUCCESS')
	                {   
                        alert("上传成功")
                        $("#imgURL").val(data.originalName + ";" + data.url);
                        $("#deleteUpload").linkbutton('enable');
                        $("#buttonUpload").linkbutton('disable');
	                }
	            },
	            error: function (data, status, e)
	            {
	                alert(e);
	            }
	        }
	    )
	    return false;
	}
	
	// 删除上传的文件
	function deleteUpload() {
		 $("#imgURL").val("");
		 $("input[name='upfile']").val("");
		 $("#deleteUpload").linkbutton('disable');
		 $("#buttonUpload").linkbutton('enable');
		 $("span[class='textbox easyui-fluid filebox']")
		 		.find("input[type='text']").val("").addClass("textbox-prompt");
	}
	
	// 添加新闻
	function addNews() {
		if($("#pwdUpdateForm").form("validate")) {
			var title = $("#newsTitle").val();
			var type = $("#type").val();
			var url = $("#imgURL").val();
			var introduction = $("#introduction").val();
			var content = UM.getEditor('myEditor').getContent();
			
			var jsonData = {"title":title, "prePictureUrl":url, "introduction":introduction, "content":content, "type":{"id":type}};
			$.ajax({
				url:'saveOrUpdate',
				data:JSON.stringify(jsonData),
				type:'POST',
				contentType:'application/json;charset=UTF-8',
				dataType:'json',
				success:function(data) {
					alert(data.message);
				},
				error:function(){
					alert("未知错误，请稍后再试");
				}
			});
		}
	}
	
	function editDialog() {
		var row = $("#dg").datagrid("getSelected");
		if(row) {
			if(row.prePictureUrl) {
				 $("span[class='textbox easyui-fluid filebox']")
			 		.find("input[type='text']").val(new String(row.prePictureUrl).split(";")[0]).removeClass("textbox-prompt");
				$("#imgURL").val(row.prePictureUrl);
				$("#deleteUpload").linkbutton('enable');
	            $("#buttonUpload").linkbutton('disable');
			}
			$('#type').val(row.typeId);
			$('#newsTitle').val(row.title);
			$('#introduction').val(row.introduction);
			UM.getEditor('myEditor').setContent(row.content, false);
			
			$('#addDialog').dialog('open');
		} else {
			alert("请选择要修改是数据");
		}
	}
	
	function editNews() {
		
	}
	</script>
	<div id="addDialog" class="easyui-dialog" title="新增资讯" closed="true" style="display:block;width:90%;overflow-y:auto;top:10px;;padding:10px"
			data-options="modal:true,doSize:true,resizable:true,iconCls:'icon-save',resizable:true,
							buttons:[{text:'提交',iconCls:'icon-ok',handler:addNews},
									{text:'取消',handler:function(){$('#addDialog').dialog('close');}}]">
		<div class="easyui-panel" style="padding:10px 40px;height:400px;width:100%;" data-options="style:{margin:'0 auto'}">
			<input name="type" id="type" type="hidden" value="2" />
			<form id="pwdUpdateForm">
			<div style="margin-bottom:10px">
				<div>标题:</div>
				<input class="easyui-validatebox textbox" id="newsTitle" validType="titleValid" required="true" missingMessage="请输入咨询标题" style="width:100%;height:26px">
			</div>
			<div style="margin-bottom:10px">
				<div>前置图:</div>
				<input size="45" name="upfile" class="easyui-filebox" style="width:50%;height:26px;" data-options="prompt:'您还没有选择文件',buttonText:'选择文件'" />
				<a href="javascript:void(0);" class="easyui-linkbutton" id="buttonUpload" onclick="ajaxFileUpload();" style="padding:0 5px;">上传</a>
				<a href="javascript:void(0);" class="easyui-linkbutton" id="deleteUpload" onclick="deleteUpload();" style="padding:0 5px;" data-options="disabled:true">删除</a>
                <input name="imgURL" id="imgURL" type="hidden" />
			</div>
			<div style="margin-bottom:10px">
				<div>内容简介:</div>
				<input class="easyui-validatebox textbox" id="introduction" required="true" validType="jianjieValid" missingMessage="请输入内容简介" style="width:100%;height:26px">
			</div>
			<script type="text/plain" id="myEditor" style="width:800px;height:240px;">
    			<p>这里输入资讯内容...</p>
			</script>
			</form>
		</div>
	</div>
</body>
</html>